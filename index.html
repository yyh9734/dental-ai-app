<!-- === index.html (Nav Bar 기능 수정 / CDN 롤백) === -->
<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InternSam - AI 진료 기록 어시스턴트</title>
    
    <!-- (★롤백됨) Tailwind CDN 스크립트 사용 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- [TODO] Google AdSense에서 발급받은 data-ad-client 코드를 여기에 붙여넣으세요. -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7443608484367770"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- (★롤백됨) @apply 규칙들을 <style> 태그로 복원 -->
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        /* (★수정됨) Primary 버튼 색상을 '라이트 핑크' 계열로 변경 (500->400) */
        .btn-primary { @apply text-white bg-pink-400 hover:bg-pink-500 focus:ring-4 focus:ring-pink-200 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300 ease-in-out shadow-md; }
        .btn-secondary { @apply text-gray-700 bg-white hover:bg-gray-100 border border-gray-300 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300 ease-in-out shadow-sm; }
        .btn-danger { @apply text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300 ease-in-out shadow-md; }
        /* (★수정됨) Copy 버튼 색상을 '라이트 핑크' 계열로 변경 (600->500, 100->50) */
        .btn-copy { @apply ml-2 text-xs text-pink-500 hover:text-pink-700 font-medium px-2 py-1 bg-pink-50 hover:bg-pink-100 rounded-md transition-all; }
        .btn-disabled { @apply bg-gray-400 text-gray-200 cursor-not-allowed; }
        .transcript-bubble { @apply p-3 rounded-lg max-w-xs md:max-w-md; }
        .transcript-patient { @apply bg-gray-100 text-gray-800 self-start; }
        /* (★수정됨) Doctor(술자) 대화창 색상을 '라이트 핑크' 계열로 변경 (500->400) */
        .transcript-doctor { @apply bg-pink-400 text-white self-end; }
        .modal-overlay { @apply fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300; }
        .modal-content { @apply bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4 transition-transform transform duration-300; }
        
        /* (★수정됨) CDN의 @apply 버그를 피하기 위해 순수 CSS로 변경 */
        /* (★삭제) .page 및 .page.active 규칙이 @apply와 충돌하므로 삭제합니다. */
        /* .page { display: none; } */
        /* .page.active { display: block; } */
    </style>
</head>
<body class="h-full bg-gray-50 text-gray-900 antialiased flex flex-col">

    <!-- 1. Navigation Bar -->
    <nav id="navbar" class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- 로고 -->
                <div class="flex-shrink-0 flex items-center">
                    <!-- (★수정) 로고/텍스트를 홈으로 가는 링크로 변경 -->
                    <a href="#home" class="nav-link flex items-center"> <!-- nav-link 클래스 추가 -->
                        <img class="h-8 w-auto" src="logo.svg" alt="InternSam Logo">
                        <span class="font-bold text-xl ml-2 text-gray-800">InternSam</span>
                    </a>
                </div>
                
                <!-- 데스크탑 메뉴 -->
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="#home" class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        홈
                    </a>
                    <a href="#about" class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        서비스 소개
                    </a>
                    <a href="#privacy" class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        개인정보 처리방침
                    </a>
                </div>

                <!-- 모바일 햄버거 버튼 -->
                <div class="sm:hidden flex items-center">
                    <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-pink-500" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg id="hamburger-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        <svg id="close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

            </div>
        </div>
        
        <!-- 모바일 메뉴 (숨겨짐) -->
        <div id="mobile-menu" class="hidden sm:hidden border-t border-gray-200">
            <div class="pt-2 pb-3 space-y-1">
                <a href="#home" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">홈</a>
                <a href="#about" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">서비스 소개</a>
                <a href="#privacy" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">개인정보 처리방침</a>
            </div>
        </div>
    </nav>

    <!-- 2. App Wrapper (페이지 컨테이너) -->
    <div id="app-wrapper" class="flex-1">
        
        <!-- ===== 2A. 메인 페이지 (홈) ===== -->
        <!-- (★수정) 'hidden' 클래스를 사용하지 않습니다. JS가 로드 시 처리합니다. -->
        <section id="mainPage" class="page h-full flex flex-col justify-center"> <!-- active 클래스 없음 -->
            <div class="flex flex-col items-center justify-center p-6 text-center bg-gradient-to-br from-pink-50 to-white">
                <div class="mb-8">
                    <!-- (★수정) 실제 로고 이미지로 변경 -->
                    <img class="h-16 w-16 mx-auto" src="logo.svg" alt="InternSam Logo">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mt-4">InternSam</h1>
                    <p id="mainSubCopy" class="text-lg md:text-xl text-gray-600 mt-3 max-w-2xl">
                        AI가 진료 대화를 분석하여 SOAP 차트를 완성합니다.
                    </p>
                </div>
                <button id="startButton" class="btn-primary !text-lg !px-8 !py-3 !rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    새 진료 녹음 시작하기
                </button>
            </div>
            
            <!-- "How it Works" 콘텐츠 -->
            <div class="py-12 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h2 class="text-3xl font-bold text-center text-gray-900">3초만에 끝나는 차팅</h2>
                    <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="text-center">
                            <!-- (★수정됨) How it Works 아이콘 색상 (라이트 핑크) -->
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-pink-400 text-white font-bold text-xl mx-auto">1</div>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">대화 녹음</h3>
                            <p class="mt-2 text-base text-gray-500">진료 중 환자와의 대화를 버튼 하나로 녹음합니다.</p>
                        </div>
                        <div class="text-center">
                            <!-- (★수정됨) How it Works 아이콘 색상 (라이트 핑크) -->
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-pink-400 text-white font-bold text-xl mx-auto">2</div>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">AI 분석 (SOAP)</h3>
                            <p class="mt-2 text-base text-gray-500">AI가 화자를 분리하고 대화 내용을 SOAP 폼으로 자동 분류합니다.</p>
                        </div>
                        <div class="text-center">
                            <!-- (★수정됨) How it Works 아이콘 색상 (라이트 핑크) -->
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-pink-400 text-white font-bold text-xl mx-auto">3</div>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">차트 복사</h3>
                            <p class="mt-2 text-base text-gray-500">완성된 요약본을 EMR/차트에 바로 복사-붙여넣기 합니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 광고 배너 영역 -->
            <div class="bg-gray-100 p-6 my-8 text-center">
                <h3 class="font-semibold text-gray-700">파트너 광고</h3>
                <!-- (★수정됨) 높이를 h-24(96px)로 줄임 -->
                <div class="mt-4 bg-gray-300 rounded-lg h-24 w-full max-w-4xl mx-auto flex items-center justify-center">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-7443608484367770"
                         data-ad-slot="YYYYYYYYYY" <!-- [TODO] 실제 Ad slot ID로 교체 필요 -->
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <!-- (★삭제) "(광고 영역 - AdSense 승인 대기 중)" 텍스트 삭제 -->
                </div>
            </div>
        </section>

        <!-- ===== 2B. 기능 페이지 (녹음기) ===== -->
        <!-- (★수정) 'hidden' 클래스를 추가하여 FOUC(깜빡임) 방지 -->
        <section id="featurePage" class="page hidden h-full flex flex-col p-4 md:p-8">
            <!-- 헤더 -->
            <header class="flex justify-between items-center pb-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">새 진료 녹음</h2>
                <button id="backButton" class="btn-secondary">홈으로</button>
            </header>
            
            <!-- (기존 녹음기 UI - 생략) ... -->
            <div class="flex flex-col items-center justify-center py-6 md:py-10 bg-white rounded-lg shadow-inner my-4 border border-gray-200">
                <button id="recordButton" class="w-20 h-20 rounded-full bg-red-600 hover:bg-red-700 shadow-lg flex items-center justify-center text-white transition-all duration-300">
                    <!-- Record Icon -->
                    <svg id="recordIcon" class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 13a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/>
                    </svg>
                    <!-- Stop Icon -->
                    <svg id="stopIcon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                    </svg>
                </button>
                <div id="timer" class="text-2xl font-semibold text-gray-700 mt-4">00:00:00</div>
                <p id="recordStatus" class="text-lg text-gray-500 mt-2">클릭하여 녹음 시작</p>
                <div id="audioPlaybackContainer" class="mt-4"></div>
            </div>
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 overflow-hidden">
                <div class="flex flex-col h-full bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <h3 class="text-lg font-semibold p-4 border-b border-gray-200">전체 대본</h3>
                    <div id="transcriptContainer" class="flex-1 p-4 space-y-3 overflow-y-auto">
                        <p class="text-gray-400 text-center mt-10">AI 처리 완료 시 이곳에 대본이 표시됩니다.</p>
                    </div>
                </div>
                <div class="flex flex-col h-full bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <h3 class="text-lg font-semibold p-4 border-b border-gray-200">SOAP 요약</h3>
                    <div class="flex-1 p-4 space-y-4 overflow-y-auto">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="soap-s" class="block text-sm font-bold text-gray-700">S (Subjective)</label>
                                <button class="btn-copy" data-target="soap-s">복사</button>
                            </div>
                            <textarea id="soap-s" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-inner bg-gray-50" readonly placeholder="환자의 주관적인 호소 내용..."></textarea>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="soap-o" class="block text-sm font-bold text-gray-700">O (Objective)</label>
                                <button class="btn-copy" data-target="soap-o">복사</button>
                            </div>
                            <textarea id="soap-o" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-inner bg-gray-50" readonly placeholder="의료진의 객관적인 검사 결과..."></textarea>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="soap-a" class="block text-sm font-bold text-gray-700">A (Assessment)</label>
                                <button class="btn-copy" data-target="soap-a">복사</button>
                            </div>
                            <textarea id="soap-a" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-inner bg-gray-50" readonly placeholder="검사 결과를 토대로 한 평가 및 진단..."></textarea>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="soap-p" class="block text-sm font-bold text-gray-700">P (Plan)</label>
                                <button class="btn-copy" data-target="soap-p">복사</button>
                            </div>
                            <textarea id="soap-p" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-inner bg-gray-50" readonly placeholder="향후 치료 계획..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== 2C. 서비스 소개 페이지 ===== -->
        <!-- (★수정) 'hidden' 클래스를 추가하여 FOUC(깜빡임) 방지 -->
        <section id="aboutPage" class="page hidden max-w-4xl mx-auto p-6 md:p-10 bg-white shadow-lg rounded-lg my-10">
            <h1 class="text-3xl font-bold text-gray-900 border-b pb-4">서비스 소개 (About InternSam)</h1>
            <div class="mt-6 space-y-4 text-gray-700">
                <p>InternSam은 바쁜 치과 진료 환경 속에서 의료진의 행정 업무 부담을 획기적으로 줄이기 위해 탄생한 AI 기반 진료 기록 어시스턴트입니다.</p>
                <h2 class="text-2xl font-semibold pt-4">핵심 문제</h2>
                <p>환자와의 진료 상담 내용은 EMR(전자 의무 기록)에 SOAP 형식으로 정확하게 기록되어야 합니다. 하지만 진료가 몰리는 시간에는 이 차팅 작업이 큰 부담이 되며, 기록이 누락되거나 지연되기 쉽습니다.</p>
                <h2 class="text-2xl font-semibold pt-4">InternSam의 해결책</h2>
                <ul class="list-disc list-inside space-y-2">
                    <li><strong>AI 기반 SOAP 노트 생성:</strong> 진료 중 대화를 녹음하면, AI가 자동으로 환자와 술자의 발언을 분리하고, 의학적 맥락을 분석하여 SOAP (Subjective, Objective, Assessment, Plan) 형식의 차트를 생성합니다.</li>
                    <li><strong>시간 절약:</strong> 차팅에 소요되는 시간을 90% 이상 절감하여, 의료진이 환자에게 더 집중할 수 있는 환경을 만듭니다.</li>
                    <li><strong>정확도 향상:</strong> AI가 대화의 핵심 내용을 놓치지 않고 객관적으로 기록하여, 차트의 완성도와 정확성을 높입니다.</li>
                </ul>
                <p class="pt-4">InternSam과 함께 더 효율적이고 환자 중심적인 진료 환경을 만들어가세요.</p>
            </div>
        </section>

        <!-- ===== 2D. 개인정보 처리방침 페이지 ===== -->
        <!-- (★수정) 'hidden' 클래스를 추가하여 FOUC(깜빡임) 방지 -->
        <section id="privacyPage" class="page hidden max-w-4xl mx-auto p-6 md:p-10 bg-white shadow-lg rounded-lg my-10">
            <h1 class="text-3xl font-bold text-gray-900 border-b pb-4">개인정보 처리방침</h1>
            <div class="mt-6 space-y-4 text-gray-600 text-sm">
                <p>InternSam(이하 '서비스')은(는) 이용자의 개인정보를 중요시하며, "정보통신망 이용촉진 및 정보보호"에 관한 법률을 준수하고 있습니다. 본 서비스는 개인정보 처리방침을 통하여 이용자가 제공하는 개인정보가 어떠한 용도와 방식으로 이용되고 있으며, 개인정보보호를 위해 어떠한 조치가 취해지고 있는지 알려드립니다.</p>
                
                <h2 class="text-xl font-semibold pt-4 text-gray-800">1. 수집하는 개인정보의 항목</h2>
                <p>본 서비스는 원활한 서비스 제공을 위해 다음의 정보를 수집할 수 있습니다.</p>
                <ul class="list-disc list-inside ml-4">
                    <li>(필수) 진료 대화 음성 파일: 서비스의 핵심 기능인 SOAP 노트 생성을 위해 수집되며, AI 분석 후 즉시 파기되거나 사용자의 별도 동의 하에 암호화되어 보관됩니다. (현재 버전에서는 서버에 저장되지 않고 즉시 처리됩니다.)</li>
                    <li>(선택) 접속 로그, 쿠키, IP 주소: 서비스 이용 통계 및 광고 최적화를 위해 수집될 수 있습니다.</li>
                </ul>

                <h2 class="text-xl font-semibold pt-4 text-gray-800">2. 개인정보의 수집 및 이용목적</h2>
                <p>서비스는 수집한 개인정보를 다음의 목적을 위해 활용합니다.</p>
                <ul class="list-disc list-inside ml-4">
                    <li>AI 기반 SOAP 노트 생성 및 제공</li>
                    <li>서비스 장애 대응 및 이용 문의 응대</li>
                    <!-- (★삭제) "(★AdSense 필수★)" 텍스트 삭제 -->
                    <li>Google AdSense 등 제3자 광고 파트너를 통한 맞춤형 광고 제공</li>
                </ul>

                <h2 class="text-xl font-semibold pt-4 text-gray-800">3. 광고 및 쿠키 사용</h2>
                <!-- (★삭제) "(★AdSense 필수★)" 텍스트 삭제 -->
                <p>본 서비스는 Google AdSense를 포함한 제3자 광고 사업자가 제공하는 광고를 게재할 수 있습니다. 이 과정에서 이용자의 브라우저에 쿠키(cookie)가 저장될 수 있습니다.</p>
                <ul class="list-disc list-inside ml-4">
                    <li>Google을 포함한 제3자 광고 사업자는 쿠키를 사용하여 본 웹사이트 또는 다른 웹사이트에 대한 이용자의 이전 방문 기록을 기반으로 광고를 게재합니다.</li>
                    <li>Google이 광고 쿠키를 사용하면 Google 및 Google의 파트너는 본 사이트 및/또는 다른 사이트의 방문 기록을 토대로 이용자에게 맞춤 광고를 표시할 수 있습니다.</li>
                    <li>이용자는 <a href="https://adssettings.google.com/authenticated" target="_blank" rel="noopener noreferrer" class="text-pink-600 hover:underline">Google 광고 설정</a>에서 맞춤 광고 게재를 중단할 수 있습니다.</li>
                </ul>

                <h2 class="text-xl font-semibold pt-4 text-gray-800">4. 개인정보의 보유 및 이용기간</h2>
                <p>음성 파일은 원칙적으로 AI 분석 완료 후 즉시 파기합니다. 단, 관련 법령의 규정에 의하여 보존할 필요가 있는 경우 회사는 아래와 같이 관계 법령에서 정한 일정한 기간 동안 회원 정보를 보관합니다.</p>
                
                <h2 class="text-xl font-semibold pt-4 text-gray-800">5. 개인정보의 파기절차 및 방법</h2>
                <p>서비스는 원칙적으로 개인정보 수집 및 이용목적이 달성된 후에는 해당 정보를 지체 없이 파기합니다. 파기절차 및 방법은 다음과 같습니다...</p>
                
                <p class="pt-4 font-semibold text-gray-800">본 방침은 2025년 11월 15일부터 시행됩니다.</p>
            </div>
        </section>
    </div>

    <!-- 3. Footer -->
    <footer id="footer" class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            <p>&copy; 2025 InternSam. All rights reserved.</p>
            <div class="mt-2 space-x-4">
                <a href="#home" class="nav-link hover:text-gray-900">홈</a>
                <a href="#about" class="nav-link hover:text-gray-900">서비스 소개</a>
                <a href="#privacy" class="nav-link hover:text-gray-900">개인정보 처리방침</a>
            </div>
        </div>
    </footer>

    <!-- 경고 모달 (기본 숨김) -->
    <div id="warningModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900">경고</h3>
            <p id="modalMessage" class="mt-2 text-sm text-gray-600">녹음 또는 처리 작업이 진행 중입니다. 정말 중단하고 메인 페이지로 이동하시겠습니까?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modalCancelButton" class="btn-secondary">취소</button>
                <button id="modalProceedButton" class="btn-danger">무시하고 이동</button>
            </div>
        </div>
    </div>

    <script>
        console.log("AI Dental App 스크립트 로드 시작 (AdSense 보강).");
        // --- DOM 요소 선택 ---
        const navbar = document.getElementById('navbar');
        const footer = document.getElementById('footer'); 
        const allPages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link'); // 헤더/푸터/로고의 모든 링크
        
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const hamburgerIcon = document.getElementById('hamburger-icon');
        const closeIcon = document.getElementById('close-icon');

        const mainPage = document.getElementById('mainPage');
        const featurePage = document.getElementById('featurePage');
        const aboutPage = document.getElementById('aboutPage');
        const privacyPage = document.getElementById('privacyPage');

        const startButton = document.getElementById('startButton');
        const backButton = document.getElementById('backButton');
        // ( ... 나머지 기능 페이지 요소들 ... )
        const recordButton = document.getElementById('recordButton');
        const recordIcon = document.getElementById('recordIcon');
        const stopIcon = document.getElementById('stopIcon');
        const timerEl = document.getElementById('timer');
        const recordStatus = document.getElementById('recordStatus'); 
        const audioPlaybackContainer = document.getElementById('audioPlaybackContainer');
        const transcriptContainer = document.getElementById('transcriptContainer');
        const copyButtons = document.querySelectorAll('.btn-copy');
        const mainSubCopy = document.getElementById('mainSubCopy');
        
        const warningModal = document.getElementById('warningModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const modalProceedButton = document.getElementById('modalProceedButton');

        // --- 녹음 관련 변수 ---
        let mediaRecorder;
        let audioChunks = [];
        let audioStream; 
        let timerInterval;
        let seconds = 0;
        
        // --- 상태 변수 ---
        let isRecording = false;
        let isProcessing = false;
        let pollingInterval = null; 
        
        // --- 상수 ---
        const API_BASE_URL = "https://dental-ai-app-xyj4.onrender.com"; 

        // --- (★수정됨) 페이지 내비게이션 로직 (hidden 클래스 사용) ---
        const showPage = (pageIdToShow) => {
            // 1. 모든 페이지 숨기기
            allPages.forEach(page => {
                // (★수정) .page.active 대신 'hidden' 클래스 사용
                page.classList.add('hidden');
            });
            
            // 2. 특정 페이지만 보이기
            const pageToShow = document.getElementById(pageIdToShow);
            if (pageToShow) {
                // (★수정) .page.active 대신 'hidden' 클래스 사용
                pageToShow.classList.remove('hidden');
            } else {
                console.error(`Page not found: ${pageIdToShow}`);
                document.getElementById('mainPage').classList.remove('hidden'); // fallback
            }

            // 3. 네비게이션 바/푸터 스타일 업데이트 (href 기반)
            const activeHref = (pageIdToShow === 'mainPage') ? '#home' : `#${pageIdToShow.replace('Page', '')}`;

            navLinks.forEach(link => {
                const linkHref = link.getAttribute('href'); 
                
                // --- (★수정됨) 데스크탑 Nav Bar 스타일 (라이트 핑크) ---
                if (link.closest('#navbar') && !link.closest('#mobile-menu') && link.querySelector('img') === null) { // 로고 링크 제외
                    link.classList.remove('border-pink-400', 'text-pink-500', 'font-semibold'); // (500/600 -> 400/500)
                    link.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                    if (linkHref === activeHref) {
                        link.classList.add('border-pink-400', 'text-pink-500', 'font-semibold'); // (500/600 -> 400/500)
                        link.classList.remove('border-transparent', 'text-gray-500');
                    }
                }
                
                // --- (★수정됨) 모바일 Nav Bar 스타일 (라이트 핑크) ---
                if (link.closest('#mobile-menu')) {
                    link.classList.remove('border-pink-400', 'text-pink-600', 'bg-pink-50', 'font-semibold'); // (500/700 -> 400/600)
                    link.classList.add('border-transparent', 'text-gray-600', 'hover:bg-gray-50', 'hover:border-gray-300', 'hover:text-gray-800');
                    if (linkHref === activeHref) {
                        link.classList.add('border-pink-400', 'text-pink-600', 'bg-pink-50', 'font-semibold'); // (500/700 -> 400/600)
                        link.classList.remove('border-transparent', 'text-gray-600');
                    }
                }

                // --- (★수정됨) 푸터 스타일 (라이트 핑크) ---
                if (link.closest('#footer')) {
                    link.classList.remove('text-pink-500', 'font-semibold'); // (600 -> 500)
                    link.classList.add('text-gray-500', 'hover:text-gray-900');
                    if (linkHref === activeHref) {
                        link.classList.add('text-pink-500', 'font-semibold'); // (600 -> 500)
                        link.classList.remove('text-gray-500');
                    }
                }
            });
            
            // 4. (★삭제) 기능 페이지에서 Nav/Footer를 숨기던 로직 제거
            
            // 5. 페이지 상단으로 스크롤
            window.scrollTo(0, 0);
        };

        // --- 페이지 전환 함수 ---
        const showFeaturePage = () => {
            showPage('featurePage');
        };

        const forceShowMainPage = () => {
            if (isRecording) {
                mediaRecorder.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            clearInterval(timerInterval);
            clearInterval(pollingInterval); 
            isRecording = false;
            isProcessing = false;
            
            resetRecordingUI();
            resetResultUI();

            showPage('mainPage'); 
            warningModal.classList.add('hidden');
        };
        
        const showMainPage = () => {
            if (isRecording || isProcessing) {
                modalMessage.textContent = isRecording
                    ? "녹음이 진행 중입니다. 정말 중단하고 메인 페이지로 이동하시겠습니까?"
                    : "파일 업로드 또는 AI 처리 작업이 진행 중입니다. 정말 중단하시겠습니까?";
                warningModal.classList.remove('hidden');
            } else {
                forceShowMainPage();
            }
        };
        
        modalCancelButton.addEventListener('click', () => {
            warningModal.classList.add('hidden');
        });
        modalProceedButton.addEventListener('click', forceShowMainPage);

        // --- 녹음 세션 초기화 (메인 -> 기능) ---
        // (★수정됨) 페이지 이동 전, 메인 페이지에서 권한을 먼저 받도록 로직 변경
        const initiateRecordingSession = async () => {
            
            try {
                // 1. (★수정) 메인 페이지에서 마이크 권한 요청
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. (★수정) 권한 성공 시 mainSubCopy 업데이트
                mainSubCopy.textContent = "마이크 권한이 확인되었습니다. 잠시 기다려주세요...";

                // 3. MediaRecorder 설정
                mediaRecorder = new MediaRecorder(audioStream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                // 4. 녹음 중지 시 (핵심 로직: 프록시 업로드)
                mediaRecorder.onstop = async () => {
                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    
                    // 녹음파일 재생기 UI 설정
                    setupAudioPlayback(audioBlob); 

                    let jobId = "";

                    try {
                        isProcessing = true;
                        recordButton.disabled = true;
                        recordButton.classList.add('btn-disabled');
                        
                        // (A) 프록시 업로드 시작
                        recordStatus.textContent = "파일 업로드 중 (서버 경유)...";
                        const formData = new FormData();
                        formData.append("audio_file", audioBlob, `recording.webm`); 

                        const response = await fetch(`${API_BASE_URL}/api/upload-audio`, {
                            method: 'POST',
                            body: formData
                        });
                        // (A) 프록시 업로드 끝

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error("업로드 실패 상세:", errorText);
                            throw new Error(`파일 업로드 실패 (${response.status})`);
                        }
                        
                        // (B) Job ID 받고 폴링 시작
                        const jobData = await response.json();
                        jobId = jobData.job_id;
                        recordStatus.textContent = "업로드 완료. AI 작업 시작...";

                        startPolling(jobId);

                    } catch (err) {
                        console.error("처리 실패:", err);
                        recordStatus.textContent = `오류 발생: ${err.message}`;
                        isProcessing = false;
                        recordButton.disabled = false;
                        recordButton.classList.remove('btn-disabled');
                    }
                };
                
                // 5. (★이동) 모든 권한/설정 완료 후 페이지 이동
                showFeaturePage();
                
                // (★추가) 기능 페이지의 상태 텍스트 초기화
                recordStatus.textContent = "클릭하여 녹음 시작";


            } catch (err) {
                console.error("마이크 권한 오류:", err);
                
                // (★수정) mainSubCopy(메인 페이지)에 오류 메시지 표시
                // (★수정) 권한 거부('denied') 상태를 감지하고 구체적인 안내 제공
                if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
                    mainSubCopy.innerHTML = `
                        <span class="font-bold text-red-600">마이크 권한이 차단되었습니다.</span><br>
                        <span class="text-sm">브라우저 주소창의 <strong class="mx-1">[자물쇠 🔒 아이콘]</strong>을 클릭하여<br>마이크 권한을 '허용'으로 변경한 후 새로고침 해주세요.</span>
                    `;
                } else if (err.name === 'NotFoundError') {
                     mainSubCopy.textContent = "오류: 연결된 마이크 장치를 찾을 수 없습니다.";
                } else {
                     mainSubCopy.textContent = `오류: 마이크를 시작할 수 없습니다. (${err.name})`;
                }
            }
        };

        // --- 폴링 함수 ---
        function startPolling(jobId) {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/get-status/${jobId}`);
                    if (!response.ok) {
                        throw new Error("작업 상태 조회 실패");
                    }
                    
                    const data = await response.json();
                    
                    // (중요) main.py/tasks.py와 상태 문자열 일치
                    switch(data.status) {
                        case 'pending':
                            recordStatus.textContent = "AI 처리 대기 중...";
                            break;
                        case 'processing_stt':
                            recordStatus.textContent = "음성 분석 중 (STT)...";
                            break;
                        case 'processing_soap':
                            recordStatus.textContent = "SOAP 요약 생성 중...";
                            break;
                        // (참고) AWS Transcribe의 세부 상태
                        case 'processing_stt (IN_PROGRESS)': 
                            recordStatus.textContent = "음성 분석 중 (STT)...";
                            break;
                        case 'processing_stt (COMPLETED)': 
                            recordStatus.textContent = "음성 분석 완료. 요약 시작...";
                            break;
                        case 'completed':
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                            recordStatus.textContent = "요약 완료! 아래를 확인하세요.";
                            isProcessing = false;
                            recordButton.disabled = false;
                            recordButton.classList.remove('btn-disabled');
                            
                            const finalResult = data.result || {};
                            
                            // UI에 결과 채우기
                            document.getElementById('soap-s').value = finalResult.s || "데이터 없음";
                            document.getElementById('soap-o').value = finalResult.o || "데이터 없음";
                            document.getElementById('soap-a').value = finalResult.a || "데이터 없음";
                            document.getElementById('soap-p').value = finalResult.p || "데이터 없음";
                            
                            if (finalResult.transcript) {
                                transcriptContainer.innerHTML = formatTranscript(finalResult.transcript);
                            } else {
                                transcriptContainer.innerHTML = '<p class="text-gray-400 text-center">대본 데이터가 없습니다.</p>';
                            }
                            break;
                        case 'failed':
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                            const errorMsg = data.result ? data.result.error_message : '알 수 없는 오류';
                            recordStatus.textContent = `처리 실패: ${errorMsg}`;
                            isProcessing = false;
                            recordButton.disabled = false;
                            recordButton.classList.remove('btn-disabled');
                            break;
                        default:
                            recordStatus.textContent = `처리 중... (상태: ${data.status})`;
                    }

                } catch (err) {
                    console.error("폴링 오류:", err);
                    recordStatus.textContent = "상태 확인 중 오류 발생...";
                    // (참고) 폴링 자체의 네트워크 오류는 계속 시도함 (clearInterval 없음)
                }
            }, 3000); // 3초마다
        }

        // 대본 포맷팅 함수 (GPT-4o가 생성한 [술자]/[환자] 태그 파싱)
        function formatTranscript(transcriptText) {
            transcriptContainer.innerHTML = ''; 
            return transcriptText.split('\n').map(line => {
                line = line.trim();
                // [술자] 태그 처리 (파란색 버블)
                if (line.startsWith('[술자]')) {
                    let content = line.replace('[술자]', '').replace(':', '').trim();
                    return `<div class="w-full flex justify-end"><div class="transcript-bubble transcript-doctor">${content}</div></div>`;
                } 
                // [환자] 태그 처리 (회색 버블)
                else if (line.startsWith('[환자]')) {
                    let content = line.replace('[환자]', '').replace(':', '').trim();
                    return `<div class="w-full flex justify-start"><div class="transcript-bubble transcript-patient">${content}</div></div>`;
                } 
                // 그 외 (타임스탬프 등)
                else if (line) {
                    return `<p class="text-sm text-gray-500 text-center">${line}</p>`; 
                }
                return '';
            }).join('');
        }

        // --- 녹음 제어 함수 ---
        const startRecording = () => {
            if (!mediaRecorder) {
                recordStatus.textContent = "녹음 장치를 초기화할 수 없습니다.";
                return;
            }
            isRecording = true;
            audioChunks = []; 
            mediaRecorder.start();
            
            // UI 업데이트: 중지 버튼 활성화
            recordIcon.classList.add('hidden');
            stopIcon.classList.remove('hidden');
            recordButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            // (★수정됨) Stop 버튼 색상을 '라이트 핑크' 계열로 변경 (600->500)
            recordButton.classList.add('bg-pink-500', 'hover:bg-pink-600');
            recordStatus.textContent = "녹음 중...";
            
            startTimer();
            audioPlaybackContainer.innerHTML = ''; // 이전 녹음 재생기 숨기기
            resetResultUI(); // 이전 결과 숨기기
        };

        const stopRecording = () => {
            if (!mediaRecorder) return;
            mediaRecorder.stop(); // -> onstop 이벤트 트리거 (업로드 시작)
            isRecording = false;
            
            // UI 업데이트: 녹음 버튼 활성화 (빨간색)
            stopIcon.classList.add('hidden');
            recordIcon.classList.remove('hidden');
            // (★수정됨) Stop 버튼 색상(라이트 핑크) 제거
            recordButton.classList.remove('bg-pink-500', 'hover:bg-pink-600');
            recordButton.classList.add('bg-red-600', 'hover:bg-red-700');
            recordStatus.textContent = "녹음 중지. 처리 시작..."; 
            
            clearInterval(timerInterval);
        };
        
        // '홈으로' 버튼 등으로 세션 강제 종료 시 UI 초기화
        const resetRecordingUI = () => {
            stopIcon.classList.add('hidden');
            recordIcon.classList.remove('hidden');
            // (★수정됨) Stop 버튼 색상(라이트 핑크) 제거
            recordButton.classList.remove('bg-pink-500', 'hover:bg-pink-600');
            recordButton.classList.add('bg-red-600', 'hover:bg-red-700');
            recordButton.disabled = false;
            recordButton.classList.remove('btn-disabled');
            recordStatus.textContent = "클릭하여 녹음 시작";
            timerEl.textContent = "00:00:00";
            seconds = 0;
            audioPlaybackContainer.innerHTML = '';
        }
        
        // 새 녹음 시작 시 이전 결과 초기화
        const resetResultUI = () => {
            document.getElementById('soap-s').value = "";
            document.getElementById('soap-o').value = "";
            document.getElementById('soap-a').value = "";
            document.getElementById('soap-p').value = "";
            transcriptContainer.innerHTML = '<p class="text-gray-400 text-center mt-10">AI 처리 완료 시 이곳에 대본이 표시됩니다.</p>';
        }

        // --- 오디오 재생 UI 설정 ---
        const setupAudioPlayback = (audioBlob) => {
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlaybackContainer.innerHTML = `
                <audio controls src="${audioUrl}" class="mt-4 rounded-lg"></audio>
                <a href="${audioUrl}" download="recording.webm" class="text-pink-600 hover:underline text-sm mt-2">
                    녹음 파일 다운로드
                </a>
            `;
        };

        // --- 타이머 함수 ---
        const startTimer = () => {
            seconds = 0;
            timerEl.textContent = "00:00:00";
            timerInterval = setInterval(() => {
                seconds++;
                timerEl.textContent = new Date(seconds * 1000).toISOString().substr(11, 8);
            }, 1000);
        };

        // --- 클립보드 복사 함수 ---
        const copyToClipboard = (button, text) => {
            if (!text) return;
            // (중요) navigator.clipboard.writeText는 https 또는 localhost에서만 작동
            // document.execCommand는 구식이지만 http 환경에서도 작동 가능성이 있음
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                button.textContent = '복사됨!';
                setTimeout(() => {
                    button.textContent = '복사';
                }, 1500);
            } catch (err) {
                console.error('클립보드 복사 실패:', err);
                button.textContent = '실패';
                 setTimeout(() => {
                    button.textContent = '복사';
                }, 1500);
            }
            document.body.removeChild(tempTextArea);
        };

        // --- 이벤트 리스너 연결 ---
        startButton.addEventListener('click', initiateRecordingSession);
        // (수정) '홈으로' 버튼은 이제 'showMainPage'를 호출 (경고 모달 로직 포함)
        backButton.addEventListener('click', showMainPage); 
        
        recordButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        copyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                const targetTextarea = document.getElementById(targetId);
                copyToClipboard(button, targetTextarea.value);
            });
        });

        // (★수정됨) 통합 네비게이션 링크 이벤트 리스너 (버그 수정)
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // (★수정됨) .closest()를 사용하여 아이콘 클릭 시에도 상위 링크(<a>)의 href를 찾음
                const targetLink = e.target.closest('.nav-link');
                if (!targetLink) return; 
                
                let pageId = targetLink.getAttribute('href').substring(1); // "home", "about", "privacy"
                
                // "home"을 "mainPage"로 매핑
                if (pageId === 'home') {
                    // (★수정됨) '홈' 버튼 클릭 시 경고 모달을 띄우는 showMainPage() 호출
                    showMainPage();
                } else {
                    pageId = pageId + 'Page'; // "about" -> "aboutPage"
                    showPage(pageId);
                }

                // (★신규) 모바일 메뉴가 열려있다면 닫기
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            });
        });
        
        // (신규) 페이지 로드 시 URL 해시(#)를 확인하여 올바른 페이지 표시
        document.addEventListener('DOMContentLoaded', () => {
            let initialPageId = window.location.hash.substring(1); // #about -> about
            if (initialPageId) {
                if (initialPageId === 'home') {
                    showPage('mainPage');
                } else {
                    // (★수정) 존재하지 않는 페이지 해시 방어
                    if (document.getElementById(initialPageId + 'Page')) {
                        showPage(initialPageId + 'Page');
                    } else {
                        showPage('mainPage');
                    }
                }
            } else {
                showPage('mainPage'); // 기본값 (HTML 로드 시 hidden이 아닌 mainPage를 숨겼다가 다시 보여줌)
            }
            
            // (신규) AdSense 스크립트가 로드된 후 광고 초기화
            try {
                 (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
                 console.error("AdSense 초기화 실패", e);
            }
        });
        
        // (★신규) 모바일 햄버거 메뉴 토글
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
            hamburgerIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        });

        console.log("AI Dental App 스크립트 로드 완료.");
    </script>
</body>
</html>